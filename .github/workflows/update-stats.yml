name: Update GitHub Stats

on:
  schedule:
    # ë§¤ì¼ í•œêµ­ì‹œê°„ ì˜¤ì „ 9ì‹œ (UTC 00:00)ì— ì‹¤í–‰
    - cron: '0 0 * * *'
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
  push:
    branches: [ main ]

jobs:
  update-stats:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        pip install requests
    
    - name: Create update script
      run: |
        cat > update_stats.py << 'EOF'
        import os
        import json
        import requests
        from datetime import datetime
        
        def get_github_stats(username, token):
            headers = {'Authorization': f'token {token}'}
            
            # ì „ì²´ ì»¤ë°‹ ìˆ˜ (ê³µê°œ ë ˆí¬)
            commits_url = f'https://api.github.com/search/commits?q=author:{username}'
            commits_resp = requests.get(commits_url, headers=headers)
            total_commits = commits_resp.json().get('total_count', 0) if commits_resp.status_code == 200 else 0
            
            # PR ìˆ˜
            pr_url = f'https://api.github.com/search/issues?q=author:{username}+type:pr'
            pr_resp = requests.get(pr_url, headers=headers)
            total_prs = pr_resp.json().get('total_count', 0) if pr_resp.status_code == 200 else 0
            
            # Issue ìˆ˜
            issue_url = f'https://api.github.com/search/issues?q=author:{username}+type:issue'
            issue_resp = requests.get(issue_url, headers=headers)
            total_issues = issue_resp.json().get('total_count', 0) if issue_resp.status_code == 200 else 0
            
            # Star ìˆ˜ (ëª¨ë“  ë ˆí¬)
            total_stars = 0
            page = 1
            while page <= 3:  # ìµœëŒ€ 3íŽ˜ì´ì§€
                repos_url = f'https://api.github.com/users/{username}/repos?per_page=100&page={page}'
                repos_resp = requests.get(repos_url, headers=headers)
                if repos_resp.status_code != 200:
                    break
                repos = repos_resp.json()
                if not repos:
                    break
                for repo in repos:
                    total_stars += repo.get('stargazers_count', 0)
                page += 1
            
            # ê¸°ì—¬í•œ ë ˆí¬ ìˆ˜
            contributed = 6  # ê¸°ë³¸ê°’, ì‹¤ì œë¡œëŠ” ë” ë³µìž¡í•œ ê³„ì‚° í•„ìš”
            
            return {
                'stars': total_stars,
                'commits': total_commits,
                'prs': total_prs,
                'issues': total_issues,
                'contributed': contributed
            }
        
        def update_gist(gist_id, content, token):
            url = f'https://api.github.com/gists/{gist_id}'
            headers = {'Authorization': f'token {token}'}
            
            # ë¨¼ì € ê¸°ì¡´ gistì˜ íŒŒì¼ëª… ê°€ì ¸ì˜¤ê¸°
            get_resp = requests.get(url, headers=headers)
            if get_resp.status_code != 200:
                return False
            
            gist_data = get_resp.json()
            filename = list(gist_data['files'].keys())[0]
            
            # ì—…ë°ì´íŠ¸
            data = {
                'files': {
                    filename: {
                        'content': content
                    }
                }
            }
            
            response = requests.patch(url, headers=headers, json=data)
            return response.status_code == 200
        
        def main():
            username = 'dugadak'
            token = os.environ.get('GH_TOKEN')
            
            if not token:
                print("Error: GH_TOKEN not found")
                return 1
            
            print(f"Fetching stats for {username}...")
            stats = get_github_stats(username, token)
            
            # Stats Gist ì—…ë°ì´íŠ¸
            stats_content = f"""â­    Total Stars:                            {stats['stars']:>5}
âž•    Total Commits:                          {stats['commits']:>5}
ðŸ”€    Total PRs:                              {stats['prs']:>5}
ðŸš©    Total Issues:                           {stats['issues']:>5}
ðŸ“¦    Contributed to:                         {stats['contributed']:>5}"""
            
            print("Updating stats gist...")
            if update_gist('6c0bbb105e1e069e12e4bcca7660ab47', stats_content, token):
                print("âœ… Stats updated!")
            else:
                print("âŒ Failed to update stats")
            
            print(f"\nUpdated stats:\n{stats_content}")
            return 0
        
        if __name__ == '__main__':
            exit(main())
        EOF
    
    - name: Update GitHub Stats
      env:
        GH_TOKEN: ${{ secrets.GH_TOKEN }}
      run: python update_stats.py
    
    - name: Job Summary
      run: |
        echo "## ðŸ“Š GitHub Stats Updated!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Stats Gist has been updated with latest data" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Check your profile: [github.com/dugadak](https://github.com/dugadak)" >> $GITHUB_STEP_SUMMARY